1) Структура репозитория и пути

- Корень репозитория (абсолютный путь на проде):
  /opt/neurosfera_venv

- Где лежит venv на проде (или создать новый):
  Текущее (по коду): /opt/neurosfera_venv
  Да, venv существует: Python 3.12.3, pip 25.1.1

- Где хранить артефакты телефонии:
  - папка для аудио TTS: /var/lib/neurosfera/audio (создать, если нет)
  - логи: /var/log/neurosfera (создать, если нет)
  Пользователь 'neurosfera' не существует. Директории не созданы.

- Порты сервисов на проде:
  - gemini_api.py: 8001 (по коду uvicorn.run(..., host="127.0.0.1", port=8001))
  - media_service.py: 8002 (по коду uvicorn.run(..., host="0.0.0.0", port=8002))
  - main.py: 8000 (по README: uvicorn main:app --port 8000)
  - новый телефония: 8087 (предлагаю; укажи, если конфликтует)
  Порты 8000, 8001, 8002 заняты. Порт 8087 свободен.

- Как запускаются сервисы на проде (systemd или screen/pm2):
  Сервисы запускаются через systemd. Юниты: fastapi.service (User=www-data), gemini_api.service (User=root), media_service.service (User=root).

2) Секреты и ENV

- Продовый env-файл:
  Подтверждаю: /etc/neurosfera/neurosfera.env (используется в `gemini_api.py`/`test_api_key.py`).

- Ключи для добавления в /etc/neurosfera/neurosfera.env:
  BEELINE_API_TOKEN=
  OPENAI_API_KEY=
  GEMINI_API_KEY=
  SIP_DOMAIN=
  SIP_USER=
  SIP_PASS=
  BOT_TEXT="Здравствуйте. Телефония временно дорабатывается"

- Локальный dev-env:
  Подтверждаю: используется ./api.env (логика загрузки есть в `gemini_api.py` → `load_env_file()`/`load_api_key()`).

3) Сетевой фронт

- Чем публикуется HTTP (Traefik / Nginx / Caddy):
  HTTP публикуется через Nginx. Docker не используется. Активные конфиги: default, media.neurosfera.su, n8n.neurosfera.su, neurosfera.su.

- Если Traefik: укажи домен/host и схему меток — добавим роутер на порт 8087.
  Не используется, т.к. фронтенд - Nginx.

- Если Nginx: нужен server-block для reverse-proxy на :8087 (дам конфиг по��ле подтверждения фронта).

- Публичный домен/поддомен для телефонии:
  На основе существующих конфигов (neurosfera.su, media.neurosfera.su) предлагается использовать telephony.neurosfera.su.

4) SIP (или API) для приёма звонка

- SIP-параметры из cloudpbx.beeline.ru:
  - SIP_DOMAIN= # нет данных
  - SIP_USER= # нет данных
  - SIP_PASS= # нет данных
  - Транспорт (udp|tcp|tls)= # нет данных
  - Обязательный кодек (по умолчанию PCMA/PCMU, 8 kHz mono WAV совместимо)= # нет данных

- Вариант интеграции на первом этапе:
  Подтверждаю SIP-ветку (автоответ + воспроизведение TTS) как быстрый старт.

- Webhook от Билайн (опционально, на будущее):
  https://telephony.neurosfera.su/beeline/webhook

5) Git-деплой (Cursor → Git → Prod)

- GitHub-репозиторий и ветки (prod/main/dev) и автодеплой:
  Remote: origin https://github.com/vladimir-chernikin/neurosfera_py.git. Ветка: main. Хук post-receive: отсутствует.

- Путь к рабочей копии на проде:
  /opt/neurosfera_venv

- Скрипт деплоя (шаги после git pull):
  - /opt/neurosfera_venv/bin/pip install -r requirements.txt
  - миграция/обновление конфигов baresip (если менялись)
  - systemctl restart нужных юнитов: neuro-telephony.service, baresip-bot@neurosfera.service, а также существующие (gemini/media/main)
  Рабочие юниты для перезапуска: fastapi.service, gemini_api.service, media_service.service.

- Интеграция телефонии (по умолчанию):
  Новые файлы (в корне репо):
    - telephony_service.py — FastAPI-сервис: ENV-логика как в `gemini_api.py` (используем `load_env_file()` и /etc/neurosfera/neurosfera.env/./api.env); эндпоинты: /health, /say-once, /beeline/webhook; TTS через OpenAI, WAV 8 kHz mono.
    - requirements.txt — добавить httpx (если нет), опционально pydantic-settings.
  Системные части (на проде):
    - Конфиг baresip �� /home/neurosfera/.baresip/ (accounts с автоответом; config с module fifo и fifo_path=/tmp/baresip_cmd).
    - systemd-юниты:
        - neuro-telephony.service → uvicorn telephony_service:app --port 8087
        - baresip-bot@neurosfera.service → SIP-клиент с автоответом
    - Reverse-proxy: Traefik labels или Nginx server-block на :8087.
  Единый install-скрипт: создание директорий, установка пакетов, выкладка конфигов, enable/start юнитов, sanity-check.

- Мягкая интеграция с текущими модулями:
  - ENV: прод-ключи в /etc/neurosfera/neurosfera.env, локально ./api.env (совпадает с текущей схемой).
  - Логи телефонии: /var/log/neurosfera/telephony_service.log (ротацию могу сделать через RotatingFileHandler+gzip по аналогии с `gemini_api.py`).
  - Порты: 8087 не пересекается с 8000/8001/8002.
  - Вызовы OpenAI/Gemini: TTS идёт через httpx напрямую, ключ из ENV (не конфликтует с `gemini_api.py`).

- Локальный запуск всех сервисов:
  Пример Makefile/скрипта (по желанию): uvicorn ... --reload для main, gemini_api, media_service, telephony_service.

Приложение: что уже известно из кода
- Порты: gemini_api=8001, media_service=8002, main=8000.
- Логи:
  - gemini_api → ./gemini_api.log (ротация + gzip)
  - media_service → /root/media_service.log + stdout
- ENV: /etc/neurosfera/neurosfera.env (prod), ./api.env (dev)
- venv: используется путь /opt/neurosfera_venv (для yt-dlp)
